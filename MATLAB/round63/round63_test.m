function round63_test()
% Test function for ROUND63.
%
% (c) 2014-2021 Stephen Cobeldick
%
% See also ROUND63 ROUND63_VIEW NUM2CIRCUIT

fun = @round63;
sgf = [15,15,15,5];
itr = 0;
cnt = 0;
if feature('hotlinks')
	fmt = '<a href="matlab:opentoline(''%1$s'',%2$3d)">%1$s %2$3d</a>';
else
	fmt = '%s %3d';
end
%
E3 = [100;220;470]/100;
E6 = [100;150;220;330;470;680]/100;
E12 = [100;120;150;180;220;270;330;390;470;560;680;820]/100;
E24 = [100;110;120;130;150;160;180;200;220;240;270;300;330;360;390;430;470;510;560;620;680;750;820;910]/100;
E48 = [100;105;110;115;121;127;133;140;147;154;162;169;178;187;196;205;215;226;237;249;261;274;287;301;316;332;348;365;383;402;422;442;464;487;511;536;562;590;619;649;681;715;750;787;825;866;909;953]/100;
E96 = [100;102;105;107;110;113;115;118;121;124;127;130;133;137;140;143;147;150;154;158;162;165;169;174;178;182;187;191;196;200;205;210;215;221;226;232;237;243;249;255;261;267;274;280;287;294;301;309;316;324;332;340;348;357;365;374;383;392;402;412;422;432;442;453;464;475;487;499;511;523;536;549;562;576;590;604;619;634;649;665;681;698;715;732;750;768;787;806;825;845;866;887;909;931;953;976]/100;
E192 = [100;101;102;104;105;106;107;109;110;111;113;114;115;117;118;120;121;123;124;126;127;129;130;132;133;135;137;138;140;142;143;145;147;149;150;152;154;156;158;160;162;164;165;167;169;172;174;176;178;180;182;184;187;189;191;193;196;198;200;203;205;208;210;213;215;218;221;223;226;229;232;234;237;240;243;246;249;252;255;258;261;264;267;271;274;277;280;284;287;291;294;298;301;305;309;312;316;320;324;328;332;336;340;344;348;352;357;361;365;370;374;379;383;388;392;397;402;407;412;417;422;427;432;437;442;448;453;459;464;470;475;481;487;493;499;505;511;517;523;530;536;542;549;556;562;569;576;583;590;597;604;612;619;626;634;642;649;657;665;673;681;690;698;706;715;723;732;741;750;759;768;777;787;796;806;816;825;835;845;856;866;876;887;898;909;920;931;942;953;965;976;988]/100;
%
%% Mfile Help %%
%
chk(500, 'E12', fun, 470)
%
chk([5,42,18,100], 'E12', fun, [4.7, 39, 18, 100])
%
chk([5,42,18,100], 'E6',               fun, [4.7, 47, 22, 100]) % default
chk([5,42,18,100], 'E6', 'harmonic',   fun, [4.7, 47, 22, 100]) % not in help.
chk([5,42,18,100], 'E6', 'up',         fun, [6.8, 47, 22, 100])
chk([5,42,18,100], 'E6', 'down',       fun, [4.7, 33, 15, 100])
chk([5,42,18,100], 'E6', 'arithmetic', fun, [4.7, 47, 15, 100])
%
chk([5,42,18,100], 'E3', fun,...
	[4.7, 47, 22, 100],...
	[  1,  4,  3,   5],...
	[4.7; 10; 22; 47; 100],...
	[2.9971; 6.3946; 13.75; 29.971; 63.946; 137.5])
%
chk([-Inf,Inf,NaN; -1, 0, 1], 'E3', fun,...
	[NaN, NaN, NaN; NaN, NaN, 1],...
	[NaN, NaN, NaN; NaN, NaN, 1],...
	1,...
	[0.63946; 1.375])
%
%% HTML Help %%
%
chk(500,'E6', fun, 470)
chk(1:6,'E12', fun, [1,2.2,3.3,3.9,4.7,5.6])
%
ipt = [5,42,18,100];
chk(ipt,'E6','harmonic',   fun, [4.7,47,22,100]) % default
chk(ipt,'E6','arithmetic', fun, [4.7,47,15,100])
chk(ipt,'E6','up',         fun, [6.8,47,22,100])
chk(ipt,'E6','down',       fun, [4.7,33,15,100])
%
chk([1,101],'E3', fun, @i, @i, @i, ...
	[0.63946;1.375;2.9971;6.3946;13.75;29.971;63.9456;137.5])

chk([1,101],'E3', fun, [1,100], @i, ...
	[1;2.2;4.7;10;22;47;100])
%
chk([1,101],'E3', fun, [1,100], [1,7], ...
	[1;2.2;4.7;10;22;47;100])
%
%% Empty %%
%
chk([], 'E3', fun, [])
chk(nan(0,0,5), 'E3', fun, nan(0,0,5))
chk(nan(1,0,5), 'E3', fun, nan(1,0,5))
chk(nan(2,0,5), 'E3', fun, nan(2,0,5))
chk(nan(3,0,5), 'E3', fun, nan(3,0,5))
chk(nan(4,0,5), 'E3', fun, nan(4,0,5))
%
%% Edgecases %%
%
chk( ones(3,5), 'E3', fun,  ones(3,5))
chk(zeros(3,5), 'E3', fun, nan(  3,5))
chk(nan(2,3,5), 'E3', fun, nan(2,3,5))
chk(inf(2,3,5), 'E3', fun, nan(2,3,5))
%
chk((1:9)*1e-154, 'E3', fun, ... smallest magnitude
	[NaN,NaN,4.7e-154,4.7e-154,4.7e-154,4.7e-154,1e-153,1e-153,1e-153])
chk((1:9)*1e+153, 'E3', fun, ... largest magnitude
	[1e+153,2.2e+153,4.7e+153,4.7e+153,4.7e+153,4.7e+153,NaN,NaN,NaN])
%
chk([2e-154,   3e-154,   6e+153, 7e+153], 'E3', fun, ... domain
	[   NaN, 4.7e-154, 4.7e+153,    NaN], [NaN,1,922,NaN])
chk([1e-154,   2e-154,   8e+153, 9e+153], 'E6', fun, ... domain
	[   NaN, 2.2e-154, 6.8e+153,    NaN], [NaN,1,1846,NaN])
chk([1e-154,   2e-154,   9e+153, 1e+154], 'E12', fun, ... domain
	[   NaN, 2.2e-154, 8.2e+153,    NaN], [NaN,1,3692,NaN])
chk([1e-154,   2e-154,   8e+153, 9e+153], 'E24', fun, ... domain
	[   NaN,   2e-154, 8.2e+153,    NaN], [NaN,1,7384,NaN])
chk([1e-154,   2e-154,   9e+153, 1e+154], 'E48', fun, ... domain
	[   NaN,1.96e-154,9.09e+153,    NaN], [NaN,1,14769,NaN])
chk([1e-154,   2e-154,   9e+153, 1e+154], 'E96', fun, ... domain
	[   NaN,   2e-154,9.09e+153,    NaN], [NaN,1,29536,NaN])
chk([1e-154,   2e-154,   9e+153, 1e+154], 'E192', fun, ... domain
	[   NaN,   2e-154,8.98e+153,    NaN], [NaN,1,59070,NaN])
%
%% Harmonic %%
%
chk(1, 'E3',   'h', fun, 1, 1, 1, [0.63946;1.3750])
chk(1, 'E6',   'h', fun, 1, 1, 1, [0.80952;1.2000])
chk(1, 'E12',  'h', fun, 1, 1, 1, [0.90110;1.0909])
chk(1, 'E24',  'h', fun, 1, 1, 1, [0.95288;1.0476])
chk(1, 'E48',  'h', fun, 1, 1, 1, [0.97593;1.0244])
chk(1, 'E96',  'h', fun, 1, 1, 1, [0.98785;1.0099])
chk(1, 'E192', 'h', fun, 1, 1, 1, [0.99396;1.0050])
%
chk(pi, 'E3',   'h', fun, 4.70, 1, 4.70, [2.9971;6.3946])
chk(pi, 'E6',   'h', fun, 3.30, 1, 3.30, [2.6400;3.8775])
chk(pi, 'E12',  'h', fun, 3.30, 1, 3.30, [2.9700;3.5750])
chk(pi, 'E24',  'h', fun, 3.00, 1, 3.00, [2.8421;3.1429])
chk(pi, 'E48',  'h', fun, 3.16, 1, 3.16, [3.0832;3.2380])
chk(pi, 'E96',  'h', fun, 3.16, 1, 3.16, [3.1246;3.1995])
chk(pi, 'E192', 'h', fun, 3.16, 1, 3.16, [3.1399;3.1799])
%
chk(25000, 'E3',   'h', fun, 22000, 1, 22000, [13750;29971])
chk(25000, 'E6',   'h', fun, 22000, 1, 22000, [17838;26400])
chk(25000, 'E12',  'h', fun, 27000, 1, 27000, [24245;29700])
chk(25000, 'E24',  'h', fun, 24000, 1, 24000, [22957;25412])
chk(25000, 'E48',  'h', fun, 24900, 1, 24900, [24285;25486])
chk(25000, 'E96',  'h', fun, 24900, 1, 24900, [24596;25196])
chk(25000, 'E192', 'h', fun, 24900, 1, 24900, [24749;25049])
%
sip = 10.^(-24:3:24); % SI prefixes
adj = eps(sip);
pns = @(v)[reshape(kron(v,10.^(-24:23)),[],1);10^24];
%
chk(sip, 'E3',   'h', fun, sip, 1:9:145,    pns(E3))
chk(sip, 'E6',   'h', fun, sip, 1:18:289,   pns(E6))
chk(sip, 'E12',  'h', fun, sip, 1:36:577,   pns(E12))
chk(sip, 'E24',  'h', fun, sip, 1:72:1153,  pns(E24))
chk(sip, 'E48',  'h', fun, sip, 1:144:2305, pns(E48))
chk(sip, 'E96',  'h', fun, sip, 1:288:4609, pns(E96))
chk(sip, 'E192', 'h', fun, sip, 1:576:9217, pns(E192))
%
%% Arithmetic %%
%
chk(1, 'E3',   'a', fun, 1, 1, 1, [0.7350;1.6000])
chk(1, 'E6',   'a', fun, 1, 1, 1, [0.8400;1.2500])
chk(1, 'E12',  'a', fun, 1, 1, 1, [0.9100;1.1000])
chk(1, 'E24',  'a', fun, 1, 1, 1, [0.9550;1.0500])
chk(1, 'E48',  'a', fun, 1, 1, 1, [0.9765;1.0250])
chk(1, 'E96',  'a', fun, 1, 1, 1, [0.9880;1.0100])
chk(1, 'E192', 'a', fun, 1, 1, 1, [0.9940;1.0050])
%
chk(pi, 'E3',   'a', fun, 2.20, 1, 2.20, [1.6000;3.4500])
chk(pi, 'E6',   'a', fun, 3.30, 1, 3.30, [2.7500;4.0000])
chk(pi, 'E12',  'a', fun, 3.30, 1, 3.30, [3.0000;3.6000])
chk(pi, 'E24',  'a', fun, 3.00, 1, 3.00, [2.8500;3.1500])
chk(pi, 'E48',  'a', fun, 3.16, 1, 3.16, [3.0850;3.2400])
chk(pi, 'E96',  'a', fun, 3.16, 1, 3.16, [3.1250;3.2000])
chk(pi, 'E192', 'a', fun, 3.16, 1, 3.16, [3.1400;3.1800])
%
chk(25000, 'E3',   'a', fun, 22000, 1, 22000, [16000;34500])
chk(25000, 'E6',   'a', fun, 22000, 1, 22000, [18500;27500])
chk(25000, 'E12',  'a', fun, 27000, 1, 27000, [24500;30000])
chk(25000, 'E24',  'a', fun, 24000, 1, 24000, [23000;25500])
chk(25000, 'E48',  'a', fun, 24900, 1, 24900, [24300;25500])
chk(25000, 'E96',  'a', fun, 24900, 1, 24900, [24600;25200])
chk(25000, 'E192', 'a', fun, 24900, 1, 24900, [24750;25050])
%
%% Up %%
%
chk(1,'E3',   'u', fun, 1, 1, 1, [0.470;1])
chk(1,'E6',   'u', fun, 1, 1, 1, [0.680;1])
chk(1,'E12',  'u', fun, 1, 1, 1, [0.820;1])
chk(1,'E24',  'u', fun, 1, 1, 1, [0.910;1])
chk(1,'E48',  'u', fun, 1, 1, 1, [0.953;1])
chk(1,'E96',  'u', fun, 1, 1, 1, [0.976;1])
chk(1,'E192', 'u', fun, 1, 1, 1, [0.988;1])
%
chk(pi, 'E3',   'u', fun, 4.70, 1, 4.70, [2.2000;4.7000])
chk(pi, 'E6',   'u', fun, 3.30, 1, 3.30, [2.2000;3.3000])
chk(pi, 'E12',  'u', fun, 3.30, 1, 3.30, [2.7000;3.3000])
chk(pi, 'E24',  'u', fun, 3.30, 1, 3.30, [3.0000;3.3000])
chk(pi, 'E48',  'u', fun, 3.16, 1, 3.16, [3.0100;3.1600])
chk(pi, 'E96',  'u', fun, 3.16, 1, 3.16, [3.0900;3.1600])
chk(pi, 'E192', 'u', fun, 3.16, 1, 3.16, [3.1200;3.1600])
%
chk(25000, 'E3',   'u', fun, 47000, 1, 47000, [22000;47000])
chk(25000, 'E6',   'u', fun, 33000, 1, 33000, [22000;33000])
chk(25000, 'E12',  'u', fun, 27000, 1, 27000, [22000;27000])
chk(25000, 'E24',  'u', fun, 27000, 1, 27000, [24000;27000])
chk(25000, 'E48',  'u', fun, 26100, 1, 26100, [24900;26100])
chk(25000, 'E96',  'u', fun, 25500, 1, 25500, [24900;25500])
chk(25000, 'E192', 'u', fun, 25200, 1, 25200, [24900;25200])
%
chk(sip-adj, 'E3',   'u', fun, sip, 1:9:145,    pns(E3))
chk(sip-adj, 'E6',   'u', fun, sip, 1:18:289,   pns(E6))
chk(sip-adj, 'E12',  'u', fun, sip, 1:36:577,   pns(E12))
chk(sip-adj, 'E24',  'u', fun, sip, 1:72:1153,  pns(E24))
chk(sip-adj, 'E48',  'u', fun, sip, 1:144:2305, pns(E48))
chk(sip-adj, 'E96',  'u', fun, sip, 1:288:4609, pns(E96))
chk(sip-adj, 'E192', 'u', fun, sip, 1:576:9217, pns(E192))
%
%% Down %%
%
chk(1,'E3',   'd', fun, 1, 1, 1, [1;2.20])
chk(1,'E6',   'd', fun, 1, 1, 1, [1;1.50])
chk(1,'E12',  'd', fun, 1, 1, 1, [1;1.20])
chk(1,'E24',  'd', fun, 1, 1, 1, [1;1.10])
chk(1,'E48',  'd', fun, 1, 1, 1, [1;1.05])
chk(1,'E96',  'd', fun, 1, 1, 1, [1;1.02])
chk(1,'E192', 'd', fun, 1, 1, 1, [1;1.01])
%
chk(pi, 'E3',   'd', fun, 2.20, 1, 2.20, [2.2000;4.7000])
chk(pi, 'E6',   'd', fun, 2.20, 1, 2.20, [2.2000;3.3000])
chk(pi, 'E12',  'd', fun, 2.70, 1, 2.70, [2.7000;3.3000])
chk(pi, 'E24',  'd', fun, 3.00, 1, 3.00, [3.0000;3.3000])
chk(pi, 'E48',  'd', fun, 3.01, 1, 3.01, [3.0100;3.1600])
chk(pi, 'E96',  'd', fun, 3.09, 1, 3.09, [3.0900;3.1600])
chk(pi, 'E192', 'd', fun, 3.12, 1, 3.12, [3.1200;3.1600])
%
chk(25000, 'E3',   'd', fun, 22000, 1, 22000, [22000;47000])
chk(25000, 'E6',   'd', fun, 22000, 1, 22000, [22000;33000])
chk(25000, 'E12',  'd', fun, 22000, 1, 22000, [22000;27000])
chk(25000, 'E24',  'd', fun, 24000, 1, 24000, [24000;27000])
chk(25000, 'E48',  'd', fun, 24900, 1, 24900, [24900;26100])
chk(25000, 'E96',  'd', fun, 24900, 1, 24900, [24900;25500])
chk(25000, 'E192', 'd', fun, 24900, 1, 24900, [24900;25200])
%
chk(sip+adj, 'E3',   'd', fun, sip, 1:9:145,    pns(E3))
chk(sip+adj, 'E6',   'd', fun, sip, 1:18:289,   pns(E6))
chk(sip+adj, 'E12',  'd', fun, sip, 1:36:577,   pns(E12))
chk(sip+adj, 'E24',  'd', fun, sip, 1:72:1153,  pns(E24))
chk(sip+adj, 'E48',  'd', fun, sip, 1:144:2305, pns(E48))
chk(sip+adj, 'E96',  'd', fun, sip, 1:288:4609, pns(E96))
chk(sip+adj, 'E192', 'd', fun, sip, 1:576:9217, pns(E192))
%
%% Character Case %%
%
chk(1.9,'e3','down', fun, 1, 1, 1)
chk(1.9,'E3','down', fun, 1, 1, 1)
chk(1.9,'E3','DOWN', fun, 1, 1, 1)
chk(1.9,'E3','D',    fun, 1, 1, 1)
chk(0.6,'E3','up',   fun, 1, 1, 1)
chk(0.6,'e3','up',   fun, 1, 1, 1)
chk(0.6,'e3','UP',   fun, 1, 1, 1)
chk(0.6,'e3','U',    fun, 1, 1, 1)
%
	function chk(varargin) % (function inputs..., fun, expected function outputs...)
		%
		dbs = dbstack();
		boo = false;
		idx = find(cellfun(@(f)isequal(f,fun),varargin));
		assert(nnz(idx)==1,'SC:round63_test:MissFun','Missing function handle.')
		xfa = varargin(idx+1:end);
		ofa = cell(size(xfa));
		%
		[ofa{:}] = fun(varargin{1:idx-1});
		%
		for k = 1:numel(xfa)
			if isequal(xfa{k},@i)
				% ignore this output
			elseif ~r63isequaln(ofa{k},xfa{k},sgf(k))
				boo = true;
				otx = r63pretty(ofa{k});
				xtx = r63pretty(xfa{k});
				ntx = min(numel(otx),numel(xtx));
				dtx = otx(1:ntx)~=xtx(1:ntx);
				fprintf(fmt, dbs(2).file, dbs(2).line);
				fprintf(' (output argument %d)\n',k);
				fprintf('output:%s\nexpect:%s\n', otx, xtx);
				fprintf('diff:  ')
				fprintf(2,'%s\n',32+char(62*dtx)); % red!
			end
		end
		cnt = cnt+boo;
		itr = itr+1;
	end
%
fprintf('%s: %d of %d testcases failed.\n',mfilename,cnt,itr)
%
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%round63_test
function ie = r63isequaln(A,B,sgf)
pA = sgf-1-floor(log10(double(A)));
pB = sgf-1-floor(log10(double(B)));
mA = A.*10.^pA;
mB = B.*10.^pB;
ie = isequal(size(A),size(B)) && all((abs(mA(:)-mB(:))<0.5) | (isnan(A(:))&isnan(B(:))));
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%r63isequaln
function out = r63pretty(inp)
if isempty(inp)&&any(size(inp)) || ndims(inp)>2 %#ok<ISMAT>
	asz = sprintf('x%d',size(inp));
	inp = inp(:);
else
	asz = '';
end
if isnumeric(inp)
	if isscalar(inp)
		out = sprintf('%.15g',inp);
	else
		fmt = repmat(',%.15g',1,size(inp,2));
		out = sprintf([';',fmt(2:end)],inp.');
		out = sprintf('%s[%s]',asz(2:end),out(2:end));
	end
else
	error('SC:round63_test:UnsupportedClass','Class "%s" is not supported',class(inp))
end
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%r63pretty